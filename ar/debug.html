<!doctype html>
<html lang="ru"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>AR Debug</title>
<style>
  body{margin:0;background:#0b0b0b;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  .wrap{max-width:820px;margin:0 auto;padding:16px}
  .card{background:#151515;border:1px solid #2a2a2a;border-radius:14px;padding:16px;margin:12px 0}
  code{background:#111;padding:2px 6px;border-radius:6px}
  .ok{color:#22c55e}.bad{color:#ef4444}
  button{padding:10px 14px;border-radius:10px;border:1px solid #444;background:#111;color:#fff;cursor:pointer}
  video{width:100%;max-width:420px;border-radius:10px;background:#000;margin-top:8px}
  pre{white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <h1>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ WebAR</h1>

  <div class="card" id="libs">
    <h3>1) –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏</h3>
    <div>THREE: <b id="t"></b>, GLTFLoader: <b id="g"></b>, MINDAR: <b id="m"></b></div>
    <div style="margin-top:8px">
      <small>–§–∞–π–ª—ã –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ –ø—É—Ç—è–º:<br>
      <code>/ar/vendor/three.min.js</code>, <code>/ar/vendor/GLTFLoader.js</code>, <code>/ar/vendor/mindar-image-three.prod.js</code></small>
    </div>
  </div>

  <div class="card" id="files">
    <h3>2) –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞</h3>
    <div>Target <code>/ar/targets/moneta.mind</code>: <b id="tt"></b></div>
    <div>Model <code>/ar/assets/hbday.glb</code>: <b id="mm"></b></div>
    <div style="margin-top:8px">
      <button id="recheck">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>
  </div>

  <div class="card">
    <h3>3) –ú–∏–Ω–∏-–∑–∞–ø—É—Å–∫ MindAR (–±–µ–∑ –º–æ–¥–µ–ª–∏)</h3>
    <div>–ï—Å–ª–∏ –≤—Å—ë –≤—ã—à–µ ¬´–∑–µ–ª—ë–Ω–æ–µ¬ª, –Ω–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª ‚Äî –¥–æ–ª–∂–µ–Ω –ø–æ–ø—Ä–æ—Å–∏—Ç—å –∫–∞–º–µ—Ä—É –∏ —É–≤–∏–¥–µ—Ç—å ¬´–º–æ–Ω–µ—Ç—É¬ª.</div>
    <div style="margin-top:8px">
      <button id="start">–°—Ç–∞—Ä—Ç</button>
      <div id="out" style="margin-top:8px"></div>
      <video id="v" playsinline muted></video>
    </div>
    <pre id="err" class="bad"></pre>
  </div>
</div>

<!-- –õ–û–ö–ê–õ–¨–ù–´–ï UMD -->
<script src="./vendor/three.min.js"></script>
<script src="./vendor/GLTFLoader.js"></script>
<script src="./vendor/mindar-image-three.prod.js"></script>

<script>
const $ = s=>document.querySelector(s);
function set(id, ok){ $(id).textContent = ok ? 'OK' : '–Ω–µ—Ç'; $(id).className = ok ? 'ok':'bad'; }
async function head(url){ try{ const r=await fetch(url,{method:'HEAD'}); return r.ok }catch{ return false } }

function readLibs(){
  set('#t', !!window.THREE);
  set('#g', !!(window.THREE && THREE.GLTFLoader));
  set('#m', !!(window.MINDAR && MINDAR.IMAGE && MINDAR.IMAGE.MindARThree));
}

async function readFiles(){
  set('#tt', await head('./targets/moneta.mind'));
  set('#mm', await head('./assets/hbday.glb'));
}

$('#recheck').onclick = ()=> readFiles();

// –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –±–µ–∑ GLB (—Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ MindAR)
$('#start').onclick = async ()=>{
  $('#err').textContent = ''; $('#out').textContent = '';
  try{
    if(!navigator.mediaDevices?.getUserMedia) throw new Error('getUserMedia –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π –≤ Safari/Chrome (–Ω–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö).');
    if(!(window.MINDAR && MINDAR.IMAGE && MINDAR.IMAGE.MindARThree)) throw new Error('MindAR –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω (vendor/mindar-image-three.prod.js).');
    const cam = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
    $('#v').srcObject = cam;

    const mindar = new MINDAR.IMAGE.MindARThree({
      container: document.body,
      imageTargetSrc: './targets/moneta.mind',
      uiScanning: true, maxTrack: 1
    });
    const {renderer, scene, camera} = mindar;
    scene.add(new THREE.HemisphereLight(0xffffff, 0x222222, 1.0));
    const anchor = mindar.addAnchor(0);
    const dot = new THREE.Mesh(new THREE.SphereGeometry(0.05), new THREE.MeshBasicMaterial({color:0x00ff99}));
    anchor.group.add(dot);

    anchor.onTargetFound = ()=> $('#out').innerHTML = 'üéØ –¢—Ä–µ–∫ –Ω–∞–π–¥–µ–Ω';
    anchor.onTargetLost  = ()=> $('#out').innerHTML = 'üîé –ü–æ—Ç–µ—Ä—è–ª —Ç—Ä–µ–∫';

    await mindar.start();
    renderer.setAnimationLoop(()=> renderer.render(scene, camera));
  }catch(e){ $('#err').textContent = '–û—à–∏–±–∫–∞: '+(e.message||e); }
};

// –ø–µ—Ä–≤–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
readLibs(); readFiles();
</script>
</body></html>
