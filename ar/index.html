<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>Mini Sculpts ‚Äî AR (ESM + DRACO + Anim + Stable)</title>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  #app{position:fixed;inset:0;overflow:hidden;background:#000}
  #ui{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.85);z-index:20;flex-direction:column;gap:12px;text-align:center;padding:24px}
  #start{padding:12px 18px;border-radius:999px;border:0;background:#22c55e;color:#000;font-weight:700;font-size:16px;cursor:pointer}
  #hud{position:fixed;left:12px;bottom:12px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 12px;font-size:14px;z-index:30;display:none}
  #err{position:fixed;top:12px;left:12px;right:12px;background:#b91c1c;color:#fff;padding:10px;border-radius:10px;display:none;z-index:40;white-space:pre-wrap}
  #dbg{position:fixed;left:12px;top:12px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 12px;font-size:12px;z-index:30;white-space:pre}
</style>

<!-- import map: –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ -->
<script type="importmap">
{
  "imports": {
    "three": "./vendor/three.module.js",
    "three/addons/": "./vendor/three/examples/jsm/",
    "mindar-image-three": "./vendor/mindar/mindar-image-three.prod.js"
  }
}
</script>
</head>
<body>
<div id="app"></div>
<div id="err"></div>
<div id="dbg">boot‚Ä¶</div>

<div id="ui">
  <h1>–ú–∏–Ω–∏-AR</h1>
  <div style="opacity:.9;max-width:560px">–†–∞–∑—Ä–µ—à–∏ –∫–∞–º–µ—Ä—É –∏ –Ω–∞–≤–µ–¥–∏ –Ω–∞ ¬´–º–æ–Ω–µ—Ç—É¬ª.</div>
  <button id="start">–ó–∞–ø—É—Å—Ç–∏—Ç—å AR</button>
  <div style="opacity:.7;font-size:13px">–û—Ç–∫—Ä—ã–≤–∞–π –≤ Chrome/Safari (–Ω–µ –≤–Ω—É—Ç—Ä–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–æ–≤). –ú–∞—Ç–æ–≤—ã–π —Å–≤–µ—Ç.</div>
</div>

<div id="hud"></div>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader }   from 'three/addons/loaders/GLTFLoader.js';
import { DRACOLoader }  from 'three/addons/loaders/DRACOLoader.js';
import { MindARThree }  from 'mindar-image-three';

const qs = new URLSearchParams(location.search);
const modelName = qs.get('model') || 'hbday.glb';        // —Ñ–∞–π–ª –≤ /ar/assets/
const s  = parseFloat(qs.get('s')  || '0.4');
const px = parseFloat(qs.get('px') || '0');
const py = parseFloat(qs.get('py') || '0.45');
const pz = parseFloat(qs.get('pz') || '0');
const rx = parseFloat(qs.get('rx') || '-90');            // –ø–æ–ø—Ä–∞–≤–∫–∞ –æ—Å–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
const ry = parseFloat(qs.get('ry') || '0');
const rz = parseFloat(qs.get('rz') || '180');
const clipName = qs.get('clip') || '';                   // ?clip=–ò–º—è–ö–ª–∏–ø–∞
const speed    = parseFloat(qs.get('speed') || '1');     // ?speed=1.0
const noModel  = qs.get('nomodel') === '1';              // ?nomodel=1 ‚Äî –±–µ–∑ GLB
const userMsg  = qs.get('msg') || '';
const noMsg    = noModel || (qs.get('nomsg') === '1');   // ?nomsg=1 ‚Äî —Å–∫—Ä—ã—Ç—å –ø–æ–¥–ø–∏—Å—å

const $ = s=>document.querySelector(s);
const log = t => { $("#dbg").textContent = t; };
const showErr = t=>{ const e=$("#err"); e.textContent=t; e.style.display='block'; };
const showHud = t=>{ const m=$("#hud"); m.innerHTML=t; m.style.display='block'; };

let mixers = [];

window.addEventListener('error', e => showErr('JS error: '+(e.error?.message||e.message||e)));
$("#start").addEventListener("click", ()=>startAR().catch(e=>showErr('–û—à–∏–±–∫–∞: '+(e.message||e))));

function makeTextSprite(text, fontSize=92){
  const c=document.createElement('canvas'), x=c.getContext('2d'), pad=32;
  x.font=`700 ${fontSize}px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial`;
  const w=Math.min(2048, Math.max(512, x.measureText(text).width+pad*2)), h=fontSize+pad*2;
  c.width=w; c.height=h; x.font=`700 ${fontSize}px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial`;
  x.textAlign='center'; x.textBaseline='middle';
  x.lineWidth=fontSize*0.16; x.strokeStyle='#000'; x.strokeText(text,w/2,h/2);
  x.fillStyle='#fff'; x.fillText(text,w/2,h/2);
  const tex=new THREE.CanvasTexture(c); tex.encoding=THREE.sRGBEncoding;
  const spr=new THREE.Sprite(new THREE.SpriteMaterial({map:tex, transparent:true}));
  const aspect=w/h, k=1.2; spr.scale.set(k*aspect,k,1); return spr;
}

async function headOk(u){ try{ const r=await fetch(u,{method:'HEAD'}); return r.ok; }catch{ return false; } }

async function startAR(){
  $("#ui").style.display="none";
  log('checking files‚Ä¶');

  if(!(await headOk('./targets/moneta.mind'))) throw new Error('–ù–µ—Ç —Ñ–∞–π–ª–∞ /ar/targets/moneta.mind');
  if(!noModel && !(await headOk('./assets/'+modelName))) throw new Error('–ù–µ—Ç –º–æ–¥–µ–ª–∏ /ar/assets/'+modelName);

  log('init MindAR‚Ä¶');
  const mindarThree = new MindARThree({
    container: document.querySelector('#app'),
    imageTargetSrc: './targets/moneta.mind',
    uiScanning: true,
    // —á—É—Ç—å –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –ø–æ–∑–∞
    filterMinCF: 0.005,
    filterBeta: 0.08,
    maxTrack: 1
  });

  const { renderer, scene, camera } = mindarThree;
  const video = mindarThree.video;

  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.outputEncoding = THREE.sRGBEncoding;

  if (video) {
    video.addEventListener('loadeddata', ()=> showHud(`model=<b>${modelName}</b> ‚Ä¢ s=${s} ‚Ä¢ üé• –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ`));
    video.addEventListener('playing',    ()=> showHud(`model=<b>${modelName}</b> ‚Ä¢ s=${s} ‚Ä¢ ‚ñ∂Ô∏è –≤–∏–¥–µ–æ –∏–≥—Ä–∞–µ—Ç`));
  }

  // —Å–≤–µ—Ç
  scene.add(new THREE.HemisphereLight(0xffffff, 0x222222, 1.0));
  const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(0,1,1); scene.add(dir);

  // —è–∫–æ—Ä—å
  const anchor = mindarThree.addAnchor(0);
  const root = new THREE.Group(); anchor.group.add(root);

  if (!noMsg && (userMsg || '').trim()) {
    const banner = makeTextSprite(userMsg, 92);
    banner.position.set(0, 0.9, 0);
    root.add(banner);
  }

  // === –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ (—Å DRACO) + —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ + –∞–Ω–∏–º–∞—Ü–∏—è ===
  if (!noModel) {
    const dracoLoader = new DRACOLoader();
    dracoLoader.setDecoderPath('./vendor/three/examples/jsm/libs/draco/');
    dracoLoader.setDecoderConfig({ type: 'wasm' });
    dracoLoader.preload();

    const loader = new GLTFLoader();
    loader.setDRACOLoader(dracoLoader);

    loader.load('./assets/'+modelName, (gltf)=>{
      const obj = gltf.scene || gltf.scenes[0];

      // —Ü–µ–ø–æ—á–∫–∞ –≥—Ä—É–ø–ø: holder(—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—ã –∏–∑ URL) ‚Üí offset(—Ü–µ–Ω—Ç—Ä/–ø–æ—Å–∞–¥–∫–∞) ‚Üí obj(–∞–Ω–∏–º–∏—Ä—É–µ–º—ã–π)
      const holder = new THREE.Group();
      const offset = new THREE.Group();
      holder.add(offset);
      offset.add(obj);
      root.add(holder);

      // —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—ã –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ holder (–∞–Ω–∏–º–∞—Ü–∏–∏ obj –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º)
      holder.scale.setScalar(s);
      holder.rotation.set(
        THREE.MathUtils.degToRad(rx),
        THREE.MathUtils.degToRad(ry),
        THREE.MathUtils.degToRad(rz)
      );
      holder.position.set(px, py, pz);

      // —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ—Å–∞–¥–∫–∞ –¥–Ω–∞ –Ω–∞ –ø–ª–æ—Å–∫–æ—Å—Ç—å
      obj.updateMatrixWorld(true);
      const box    = new THREE.Box3().setFromObject(obj);
      const center = box.getCenter(new THREE.Vector3());
      const bottom = box.min.y;

      offset.position.sub(center);               // —Ü–µ–Ω—Ç—Ä –≤ (0,0,0)
      offset.position.y += (center.y - bottom);  // ¬´–¥–Ω–æ¬ª –Ω–∞ y=0

      // –∞–Ω–∏–º–∞—Ü–∏–∏
      if (gltf.animations && gltf.animations.length) {
        const mixer = new THREE.AnimationMixer(obj);
        let clip = gltf.animations[0];
        if (clipName) {
          const found = THREE.AnimationClip.findByName(gltf.animations, clipName);
          if (found) clip = found;
        }
        const action = mixer.clipAction(clip);
        action.timeScale = speed || 1.0;
        action.setLoop(THREE.LoopRepeat);
        action.clampWhenFinished = false;
        action.play();
        mixers.push(mixer);
        showHud(`üé¨ ${clip.name} ‚Ä¢ model=<b>${modelName}</b> ‚Ä¢ s=${s}`);
      } else {
        showHud('‚ö†Ô∏è –í GLB –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∫–ª–∏–ø–æ–≤ –∞–Ω–∏–º–∞—Ü–∏–∏');
      }
    }, undefined, (err)=> showErr('GLTF_LOAD_FAIL: '+err.message));
  }

  anchor.onTargetFound = ()=> showHud('üéØ –¢—Ä–µ–∫ –Ω–∞–π–¥–µ–Ω');
  anchor.onTargetLost  = ()=> showHud('üîé –î–µ—Ä–∂–∏ ¬´–º–æ–Ω–µ—Ç—É¬ª –≤ –∫–∞–¥—Ä–µ');

  try{
    log('start camera‚Ä¶');
    await mindarThree.start();
    log('render loop‚Ä¶');
    const clock = new THREE.Clock();
    renderer.setAnimationLoop(()=>{
      const dt = Math.min(0.033, clock.getDelta());
      for (const m of mixers) m.update(dt);
      renderer.render(scene, camera);
    });
  }catch(e){
    showErr('MINDAR_START_FAIL: '+e.message+'\n–ü—Ä–æ–≤–µ—Ä—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã –∏ –æ—Ç–∫—Ä–æ–π —Å—Å—ã–ª–∫—É –≤ —á–∏—Å—Ç–æ–º Chrome/Safari.');
  }
}
</script>
</body>
</html>
